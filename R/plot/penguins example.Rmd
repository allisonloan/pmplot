
#Load
```{r}
library(ggplot2)
library(palmerpenguins)
library(pmplot)  
library(grid) 
```


#pmplot example using penguins dataset
```{r}
# pmplot example using penguins dataset

# Clean data for plotting
peng <- subset(
  penguins,
  !is.na(species) & !is.na(island) & !is.na(sex) &
    !is.na(bill_length_mm) & !is.na(flipper_length_mm)
)

# A base scatter we’ll reuse
base_b <- ggplot(peng, aes(bill_length_mm, flipper_length_mm, color = species)) +
  geom_point(alpha = 0.6) +
  scale_color_brewer(palette = "Dark2") +
  labs(x = "Bill length (mm)", y = "Flipper length (mm)", color = "Species") +
  theme_minimal(base_size = 12)

# -------------------------
# P1 — Mixed horizontals + verticals (now using groups)
# -------------------------
# Idea: split x into 2 equal-width bins (short vs long bills) and y into 2 bins
# to mark short vs long flippers. Positions are in NPC via n_groups + g_start/g_end.

# Top brackets (x split into 2 equal regions)
p1 <- add_by_groups(
  base_b,
  side    = "top",
  labels  = c("Short Bills", "Long Bills"),
  n_groups = 2,
  g_start = c(1, 2),       # left half, right half
  g_end   = c(1, 2),
  pos     = 1.06,          # nudge above panel
  pad     = 0.03,
  label_offset = 0.05
)

# Right brackets (y split into 2 equal regions)
p1 <- add_by_groups(
  p1,
  side    = "right",
  labels  = c("Short Flippers", "Long Flippers"),
  n_groups = 2,
  g_start = c(1, 2),       # lower half, upper half
  g_end   = c(1, 2),
  pos     = 1.06,          # nudge to the right of panel
  pad     = 0.03,
  label_offset = 0.05
)

# Nudge legend far right so it won’t overlap brackets
p1 <- p1 + theme(
  legend.position = c(1.15, 0.5),
  legend.justification = c("left", "center"),
  plot.margin = margin(t = 40, r = 150, b = 0, l = 0)
)

ggsave(filename = "../plot/p1.png", p1, dpi = 300)
p1

# -------------------------
# P2 — Stacked horizontals (top) using group-based spans
# -------------------------
# We’ll split x into 3 equal bins and label them like species clusters,
# plus one "All Penguins" band spanning all 3 bins at a higher y.

p2 <- add_brackets_simple(
  base_b,
  side  = "top",
  start = c(0.04, 0.36, 0.50, 0.04),   # manual NPC coords
  end   = c(0.30, 0.96, 0.96, 0.96),
  pos   = c(1.04, 1.04, 1.12, 1.20),   # vertical position
  label = c("Adelie", "Chinstrap", "Gentoo", "All Penguins"),
  label_offset = 0.04
)
ggsave(filename = "../plot/p2.png", p2, dpi = 300)
p2
# -------------------------
# P3 — Vertical brackets (right) on body mass by sex
# -------------------------
peng_w <- subset(penguins, !is.na(sex) & !is.na(body_mass_g))

base_w <- ggplot(peng_w, aes(x = sex, y = body_mass_g, col = species)) +
  geom_jitter(width = 0.7, alpha = 0.85)  +
  scale_fill_brewer(palette = "Pastel1", guide = "none") +
  theme_minimal(base_size = 12) +
  labs(x = NULL, y = "Body mass (g)") +
  theme(legend.position = "bottom",
        plot.margin = margin(40, 0, 0, 0))

# Split y into 2 equal regions (low vs high mass)
p3 <- add_by_groups(
  base_w,
  side    = "right",
  labels  = c("Lower Mass", "Higher Mass"),
  n_groups = 2,
  g_start = c(1, 2),
  g_end   = c(1, 2),
  pos     = 1.06,
  pad     = 0.03,
  label_offset = 0.04,
  lwd = 1.3
)

ggsave(filename = "../plot/p3.png", p3, dpi = 300)
p3
# -------------------------
# P4 — Horizontal brackets (top) on island × species proportions
# -------------------------
peng_i <- subset(penguins, !is.na(island) & !is.na(species))

base_i <- ggplot(peng_i, aes(x = island, fill = species)) +
  geom_bar(position = "fill", colour = "grey25", alpha = 0.9) +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = NULL, y = "Species mix (proportion)", fill = "Species") +
  theme_minimal(base_size = 12) +
  theme(legend.position = "bottom")

# There are 3 islands on x → make 2 bands: first two islands grouped, then last island
p4 <- add_by_groups(
  base_i,
  side    = "top",
  labels  = c("Mixed", "Adelie"),
  n_groups = 3,
  g_start = c(1, 3),       # groups 1..2, and 3..3
  g_end   = c(2, 3),
  pos     = 1.06,
  pad     = 0.03,
  label_offset = 0.055,
  lwd = 1.2
)

ggsave(filename = "../plot/p4.png", p4, dpi = 300)
p4

```

#Patchwork for final figures
```{r}
library(patchwork)

# Group p1 and p2 together and share legend only within this group
p1p2 <- (p1 + p2) +
  plot_layout(guides = "collect") &    # legend sharing inside this group
  theme(legend.position = "right")     # legend position for p1 & p2

# Combine with p3 and p4 (these keep their own legends)
final_plot <- (p1p2) / (p3 | p4) +
  plot_annotation(
    tag_levels = "A",   # adds A, B, C, D labels
    tag_suffix = ")"
  )
print(final_plot)
# Save as A4
ggsave(
  filename = "../plot/final_plot_A4.png",
  plot = final_plot,
  width = 8.27, height = 11.69, units = "in", dpi = 300
)

```

# Adding Significance
```{r}
df <- data.frame(
  group = c("A","B","C"),
  mean  = c(5, 7, 6),
  se    = c(0.5, 0.4, 0.6)
)

p <- ggplot(df, aes(x = group, y = mean)) +
  geom_col(fill = "skyblue") +
  geom_errorbar(aes(ymin = mean - se, ymax = mean + se), width = 0.2) +
  ylim(0, 9) +
  coord_cartesian(clip = "off") +
  theme_minimal()


p5 <- add_brackets_simple(
  p, side = "top", coord = "data",
  labels = c("**", "All groups"),
  start  = c(1.0, 0.5),
  end    = c(2.0, 3.5),
  pos    = c(8.2, 10),
  label_offset = c(0.03, 0.04),
  label_size   = c(10, 14),
  fontface     = c("bold", "plain")) 

p5
ggsave(filename = "../plot/significance.png", plot = p5, dpi = 300)
```


